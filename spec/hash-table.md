
## Hash Function

- Poseidon ([paper](https://eprint.iacr.org/2019/458.pdf)).
- Collision and second preimage resistance target: 128 bits.
- On the BN254 scalar field.
- S-box: x^5.
- Full rounds: 8.
- Partial rounds (S-box on the first "capacity" state): 57.
- Constants: as generated by `src/poseidon/primitives.rs / Spec::constants()`
- Capacity: 1 element.
- Rate: 2 elements.


## Interface Table

The hash circuit exposes a table containing multiple inputs/output pairs. This table can be looked up by the MPT and codehash circuits. The table has four columns: 2 inputs, 1 digest output, and 1 for control flags.

| 0: Hash index   | 1: Message       | 2: Message      | 3: Control flag |
| --------------- | ---------------- | --------------- | --------------- |
| MPT digest      | MPT input 1      | MPT input 2     |      0          |
|                 |                  |                 |                 |
| var-len digest  | word 0           | word 1          |     2000        |
| var-len digest  | word 2           | word 3          |     1968        |
|      ...        |      ...         |     ...         |     ...         |
| var-len digest  | word W-2         | word W-1        |      16         |
|                 |                  |                 |                 |


The hash circuit supports two modes:

### MPT Mode

Compute the digest of two message words, as in Merkle trees. This type of entries is identified by the control flag value of 0.

**Initial capacity:** `0`.

**Message encoding:** each message word is a field element; that is, each word is a digest from the previous MPT layer.

### Var-Len Mode

Compute the digest of a variable-length message. One such entry is composed of consecutive rows with the same digest value, and where the control flag is not 0.

**Initial capacity:** `L * 2^64`, with `L` the message length in bytes (before padding).

**Message encoding:** The message is chunked into `W` words of `STEP/2` bytes. Each word is packed into a field element, least-significant-byte first. The words are given two-by-two on consecutive rows in the table, absorbing `STEP` bytes per row. The control flag on a given row indicates the number of message bytes remaining in the current and following rows. On the last row, `control <= STEP`.

**Padding:** the message is padded to a multiple of `STEP` bytes with zeros.

Specifically, `STEP = 32`.


## Internal Table (hash_table_aux)

| Row      | 0: State (capacity) | 1: State (rate) | 2: State (rate) | 3: State-for-next | 4: State-for-next | 5: Hash Out |
| -------- | ------------------- | --------------- | --------------- | ----------------- | ----------------- | ----------- |
| previous |                     |                 |                 |                   |                   |             |
| current  |                     |                 |                 |                   |                   |             |

